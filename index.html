<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Call</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 1rem;
      background: #f2f2f2;
    }
    video {
      width: 300px;
      margin: 1rem;
      border: 2px solid #333;
      border-radius: 10px;
    }
    #videos {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    #chat {
      width: 300px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 1rem;
      background: white;
      padding: 0.5rem;
      border: 1px solid #ccc;
    }
    input, button {
      margin: 0.5rem;
    }
    #chat-box {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .username-label {
      font-weight: bold;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

<h2>ðŸŽ¥ Video Call with Chat, Screen Sharing & Username</h2>

<p>Your ID: <span id="my-id">...</span></p>
<p>Your Username: <span id="my-username">...</span></p>

<input id="peer-id" placeholder="Enter peer ID to call">
<button onclick="callPeer()">Call</button>

<div id="videos">
  <div>
    <div class="username-label">You</div>
    <video id="my-video" autoplay muted></video>
  </div>
  <div>
    <div class="username-label" id="peer-username">Peer</div>
    <video id="peer-video" autoplay></video>
  </div>
</div>

<div id="chat-box">
  <div id="chat"></div>
  <input id="message" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>
</div>

<button onclick="shareScreen()">Share Screen</button>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
  const myVideo = document.getElementById('my-video');
  const peerVideo = document.getElementById('peer-video');
  const chatBox = document.getElementById('chat');
  const peerIdInput = document.getElementById('peer-id');
  const messageInput = document.getElementById('message');
  const myUsernameDisplay = document.getElementById('my-username');
  const peerUsernameDisplay = document.getElementById('peer-username');

  let localStream;
  let currentCall;
  let conn;
  let peer;
  let myCustomId;
  let myUsername;
  let peerUsername = "Peer";
  const maxRetries = 5;

  // Ask for username on load
  window.onload = () => {
    myUsername = prompt("Enter your username:");
    if (!myUsername) myUsername = "Anonymous";
    myUsernameDisplay.textContent = myUsername;
    createPeerWithRetry();
  };

  function createPeerWithRetry(retries = 0) {
    myCustomId = Math.floor(1000 + Math.random() * 9000).toString();
    peer = new Peer(myCustomId);

    peer.on('open', id => {
      document.getElementById('my-id').textContent = id;
      console.log(`Connected with ID: ${id}`);
      setupPeerEvents();
    });

    peer.on('error', err => {
      if (err.type === 'unavailable-id' && retries < maxRetries) {
        console.warn(`ID ${myCustomId} taken, retrying...`);
        createPeerWithRetry(retries + 1);
      } else {
        alert('Failed to create peer. Please refresh the page.');
        console.error(err);
      }
    });
  }

  function setupPeerEvents() {
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        myVideo.srcObject = stream;
      });

    peer.on('call', call => {
      call.answer(localStream);
      call.on('stream', remoteStream => {
        peerVideo.srcObject = remoteStream;
      });
      currentCall = call;
    });

    peer.on('connection', incomingConn => {
      conn = incomingConn;

      conn.on('open', () => {
        console.log('Data connection opened (incoming)');
        // Send our username to the peer
        conn.send(JSON.stringify({ type: "username", name: myUsername }));
      });

      conn.on('data', data => {
        try {
          const msg = JSON.parse(data);
          if (msg.type === "username") {
            peerUsername = msg.name;
            peerUsernameDisplay.textContent = peerUsername;
          } else if (msg.type === "chat") {
            addMessage(`${peerUsername}: ${msg.text}`);
          }
        } catch (e) {
          console.warn("Non-JSON data:", data);
        }
      });
    });
  }

  function callPeer() {
    const id = peerIdInput.value;

    conn = peer.connect(id);

    conn.on('open', () => {
      console.log('Data connection opened (outgoing)');
      conn.send(JSON.stringify({ type: "username", name: myUsername }));
    });

    conn.on('data', data => {
      try {
        const msg = JSON.parse(data);
        if (msg.type === "username") {
          peerUsername = msg.name;
          peerUsernameDisplay.textContent = peerUsername;
        } else if (msg.type === "chat") {
          addMessage(`${peerUsername}: ${msg.text}`);
        }
      } catch (e) {
        console.warn("Non-JSON data:", data);
      }
    });

    const call = peer.call(id, localStream);
    call.on('stream', remoteStream => {
      peerVideo.srcObject = remoteStream;
    });
    currentCall = call;
  }

  function sendMessage() {
    const msg = messageInput.value;
    if (conn && conn.open) {
      conn.send(JSON.stringify({ type: "chat", text: msg }));
      addMessage(`You: ${msg}`);
      messageInput.value = '';
    } else {
      alert('Connection not established yet!');
    }
  }

  function addMessage(msg) {
    const div = document.createElement('div');
    div.textContent = msg;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function shareScreen() {
    navigator.mediaDevices.getDisplayMedia({ video: true })
      .then(screenStream => {
        const screenTrack = screenStream.getVideoTracks()[0];
        const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
        sender.replaceTrack(screenTrack);

        screenTrack.onended = () => {
          const videoTrack = localStream.getVideoTracks()[0];
          sender.replaceTrack(videoTrack);
        };
      })
      .catch(err => {
        alert('Screen share failed: ' + err);
      });
  }
</script>

</body>
</html>
